#!/bin/bash
# Usage: ./migrate [check|apply|revert] [message]

set -e

# Get the directory where this script is located
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SHARED_DIR="$ROOT_DIR/shared"

COMMAND=$1
MESSAGE=$2

case "$COMMAND" in
  check)
    if [ -z "$MESSAGE" ]; then
      echo "Error: Migration message required for 'check'. Usage: ./migrate check \"your message\""
      exit 1
    fi
    echo "Generating migration: $MESSAGE"
    (cd "$SHARED_DIR" && uv run alembic revision --autogenerate -m "$MESSAGE")
    ;;
  apply)
    echo "Applying migrations..."
    (cd "$SHARED_DIR" && uv run alembic upgrade head)
    ;;
  revert)
    echo "Reverting last migration..."
    (cd "$SHARED_DIR" && uv run alembic downgrade -1)
    ;;
  *)
    echo "Usage: ./migrate [check|apply|revert] [message]"
    echo "  check <message> - Generate a new migration"
    echo "  apply           - Apply all pending migrations"
    echo "  revert          - Revert the last applied migration"
    exit 1
    ;;
esac
